<!DOCTYPE html>
<html>

<head>
   <!-- basic -->
   <meta charset="utf-8">
   <meta http-equiv="X-UA-Compatible" content="IE=edge">
   <meta name="viewport" content="width=device-width, initial-scale=1">
   <!-- mobile metas -->
   <meta name="viewport" content="width=device-width, initial-scale=1">
   <meta name="viewport" content="initial-scale=1, maximum-scale=1">
   <!-- site metas -->
   <title>üèéÔ∏è | STI Kart</title>
   <meta name="keywords" content="">
   <meta name="description" content="">
   <meta name="author" content="">
   <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
   <link rel="stylesheet" type="text/css" href="css/style.css">
   <link rel="stylesheet" href="css/responsive.css">
   <!-- fevicon -->
   <link rel="icon" href="images/fevicon.png" type="image/gif" />
   <!-- CSS -->
   <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
   <link rel="stylesheet" href="css/jquery.mCustomScrollbar.min.css">
   <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css">
   <link href="https://cdn.datatables.net/1.13.1/css/jquery.dataTables.min.css" rel="stylesheet">
   <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.dataTables.min.css">
   <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
   <link href="./bootstrap-select.css" rel="stylesheet">



   <!-- BIBLIOTECAS -->
   <script src="./js/funcoes.js"></script>
   <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
   <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
   <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
   <script src="https://code.jquery.com/jquery-3.6.1.min.js"
      integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
   <script src="https://cdn.datatables.net/1.13.1/js/jquery.dataTables.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment-with-locales.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/js/all.min.js"
      integrity="sha512-u3fPA7V8qQmhBPNT5quvaXVa1mnnLSXUep5PS1qo5NRzHwG19aHmNJnj1Q8hpA/nBWZtZD4r4AX6YOt5ynLN2g=="
      crossorigin="anonymous" referrerpolicy="no-referrer"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.18/js/bootstrap-select.min.js"></script>

   <script src="js/popper.min.js"></script>
   <script src="js/bootstrap.bundle.min.js"></script>
   <script src="js/plugin.js"></script>
   <script src="https://d3js.org/d3.v7.min.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
   <script src="https://cdn.datatables.net/responsive/2.2.9/js/dataTables.responsive.min.js"></script>

   <script src="js/jquery.mCustomScrollbar.concat.min.js"></script>
   <script src="js/custom.js"></script>
</head>

<body>
   <div class="header_section header_bg">
      <div class="container">
         <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <a class="navbar-brand" href="index.html">
               <div class="h5 text-white">üèÅ<span class="font-italic"><span class="font-weight-light">KART//</span><span
                        class="font-weight-bold">STI</span></span></div>
            </a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
               aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
               <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
               <ul class="navbar-nav ml-auto">
                  <li class="nav-item">
                     <a class="nav-link" href="corridas.html">Corridas</a>
                  </li>
                  <li class="nav-item">
                     <a class="nav-link" href="pilotos.html">Pilotos</a>
                  </li>
                  <li class="nav-item">
                     <a class="nav-link active" href="ranking.html">Ranking</a>
                  </li>
                  <li class="nav-item">
                     <a class="nav-link" href="recordes.html">Recordes</a>
                  </li>
                  <li class="nav-item">
                     <a class="nav-link" href="regulamento.html">Regulamento</a>
                  </li>

               </ul>
            </div>
         </nav>
      </div>
   </div>

   <div class="contact_section layout_padding">
      <div class="container">
         <div class="h1 contact_taital">Ranking</div>
         <div><select id="selecionadorDeRanking">
            </select></div>
         <div class="table-responsive">
            <table id="tabelaRanking" class="table-hover-coffee table-coffee" style="width:100%">
            </table>
         </div>
      </div>
   </div>

   <div class="copyright_section">
      <div class="container">
         <div class="row">
            <div class="col-sm-12">
               <p class="copyright_text">2024 | Rafael Nobre Leite.<br>Design by <a href="https://html.design">Free
                     Html
                     Templates</a>
                  Distribution by <a href="https://themewagon.com">ThemeWagon</a></p>
            </div>
         </div>
      </div>
   </div>
</body>

<script>
   $(document).ready(async function () {

      const RANKINGS = {};
      await loadFileList();
      window.RANKINGS_VETOR = reorganizarDadosRanking(RANKINGS);
      preencherSelecionadorRanking(RANKINGS_VETOR);
      gerarTabelaDeRanking();

      function loadJsonFiles(files) {
         const fetchPromises = files.map((file) => {
            const url = `./data/ranking/${file}`;
            return fetch(url)
               .then((response) => {
                  if (!response.ok) {
                     throw new Error(`Erro ao carregar ${file}: ${response.statusText}`);
                  }
                  return response.json();
               })
               .then((jsonData) => {
                  const fileName = file.replace('.json', '');
                  RANKINGS[fileName] = jsonData;
               })
               .catch((error) => console.error('Erro ao carregar arquivo JSON:', error));
         });

         return Promise.all(fetchPromises);
      }

      function loadFileList() {
         const url = './data/ranking/lista_rankings.json';

         return fetch(url)
            .then((response) => {
               if (!response.ok) {
                  throw new Error(`Erro ao carregar lista de arquivos: ${response.statusText}`);
               }
               return response.json();
            })
            .then((fileList) => {
               return loadJsonFiles(fileList);
            })
            .then(() => {
               console.log('Rankings carregados');
            })
            .catch((error) => console.error('Erro ao carregar lista de arquivos:', error));
      }
   });

   function preencherSelecionadorRanking(RANKINGS_VETOR) {
      $(`#selecionadorDeRanking`).html(RANKINGS_VETOR.map((r, idx) => {
         return `<option value="${r.ranking}" ${idx + 1 == RANKINGS_VETOR.length ? `selected` : ``}>${idx + 1}¬™ Atualiza√ß√£o - ${moment(r.ranking, 'YYYYMMDD').format('DD/MM/YYYY')}</option>`
      }));

      $('.selectpicker').selectpicker('refresh');
      $(`select`).niceSelect('update');

      $(`#selecionadorDeRanking`).change(el => gerarTabelaDeRanking($(`#selecionadorDeRanking`).val()));
   }

   function gerarTabelaDeRanking(ranking = null) {

      if (ranking == null) {
         dadosIdx = RANKINGS_VETOR.length - 1;
      } else {
         dadosIdx = RANKINGS_VETOR.findIndex(r => r.ranking == ranking)
      }

      console.log(RANKINGS_VETOR[dadosIdx].total);

      window.callDetalhesTabelaDeRankings = false;

      if (window.hasOwnProperty('tabelaRanking')) {
         $(`#tabelaRanking`).DataTable().destroy();
         callDetalhesTabelaDeRankings = false;
      }

      window.tabelaRanking = $(`#tabelaRanking`).DataTable({
         data: RANKINGS_VETOR[dadosIdx]['total'],
         dom: 'rt',
         ordering: false,
         pageLength: -1,
         columns: [
            {
               data: 'POS',
               class: 'text-center align-middle pointer h5',
               render: function (data, type, full, meta) {
                  return `${data}¬∫`;
               }
            },
            {
               data: 'NOME',
               class: 'align-middle pointer'
            },
            {
               data: 'PTOTAL',
               class: 'text-center align-middle pointer',
               render: function (data, type, full, meta) {
                  return `<strong>${numeroBr(data, 2)}</strong> Pts.`;
               }
            },
            {
               data: 'POS',
               class: 'text-center align-middle pointer',
               render: function (data, type, full, meta) {
                  if (dadosIdx == 0) {
                     return '';
                  } else {
                     let PILOTO_ANTERIOR = RANKINGS_VETOR[dadosIdx - 1]['total'].find(p => p.NOME == full.NOME);
                     if (PILOTO_ANTERIOR) {
                        let POS_ANTERIOR = PILOTO_ANTERIOR.POS;
                        return calcularVariacao(POS_ANTERIOR, full.POS);
                     } else {
                        return '‚òÖ';
                     }
                  }
               }
            }
         ]
      });

      // if (!callDetalhesTabelaDeRankings) {
      //    callDetalhesTabelaDeRankings = true;
      //    configurarDetalhesTabelaDeRankings(dados);
      // }
   }

   async function configurarDetalhesTabelaDeClassifica√ß√£oCorrida(CORRIDA) {
      $(`#tabelaDeClassifica√ß√£oCorrida tbody`).on(`click`, `td.pointer`, async function () {
         let tr = $(this).closest(`tr`);
         let row = tabelaDeClassifica√ß√£oCorrida.row(tr);

         if (row.child.isShown()) {
            row.child.hide();
            tr.removeClass(`active`);
         } else {
            $('#tabelaDeClassifica√ß√£oCorrida tr').removeClass('active');

            $('#tabelaDeClassifica√ß√£oCorrida').DataTable().rows().every(function () {
               var row = this;

               if (row.child.isShown()) {
                  row.child.hide();
                  $(row.node()).removeClass('shown');
               }
            });

            gerarDetalhePiloto(row.data(), CORRIDA).then(el => row.child(el, 'child p-3').show());
            tr.addClass(`active`);
         }
      });
   }

   async function gerarDetalhePiloto(d, CORRIDA) {

      let tt = CORRIDA.tomada_de_tempo.find(el => el.NOME == d.NOME);
      let detalhesPiloto = [`<div class="h6">Estat√≠sticas</div>`];
      let pontuacao = [`<div class="h6">Pontua√ß√£o</div>`];

      d['VLTS'] && detalhesPiloto.push(`<div><b>N√∫mero de voltas: </b>${d['VLTS']}</div>`);
      d['TT'] && detalhesPiloto.push(`<div><b>Tempo total: </b>${d['TT'].replace('.', ',')}</div>`);
      d['VM'] && detalhesPiloto.push(`<div><b>Velocidade M√©dia: </b>${numeroBr(d['VM'], 2)} Km/h</div>`);
      d['TMV'] && detalhesPiloto.push(`<div><b>Tempo da Melhor Volta: </b>${d['TMV'].replace('.', ',')}</div>`);
      d['DA'] && d['DA'] != '---' && detalhesPiloto.push(`<div> <b>Diferen√ßa para o anterior: </b>${d['DA'].replace('.', ',')}</div>`);

      let pcc = caulcarPCC(d['POS'], CORRIDA.corrida.length);
      let pmv = d['MVC'] ? caulcarPMV(CORRIDA.corrida.length) : 0;
      let pctt = caulcarPCTT(tt['POS'], CORRIDA.tomada_de_tempo.length);
      let pvc = caulcarPVC(d.MAPA_VOLTAS.filter(el => el).length + tt.MAPA_VOLTAS.filter(el => el).length);

      pontuacao.push(`<div><b>P<sub>CC</sub>: </b>${numeroBr(pcc, 2, 2)}</div>`);
      pontuacao.push(`<div><b>P<sub>MV</sub>: </b>${numeroBr(pmv, 2, 2)}</div>`);
      pontuacao.push(`<div><b>P<sub>CTT</sub>: </b>${numeroBr(pctt, 2, 2)}</div>`);
      pontuacao.push(`<div><b>P<sub>VC</sub>: </b>${numeroBr(pvc, 2, 2)}</div>`);
      pontuacao.push(`<div><b>Pontua√ß√£o Total: </b>${numeroBr(pcc + pmv + pctt + pvc, 2, 2)}</div>`);


      return `<div class="row">
         <div class="col-6">${detalhesPiloto.join('')}</div>
         <div class="col-6">${pontuacao.join('')}</div>
         </div>`
   }

   function calcularVariacao(POS_ANTERIOR, POS) {
      if (POS_ANTERIOR > POS) {
         return `‚ñ≤ ${POS_ANTERIOR - POS}`;
      } else if (POS_ANTERIOR == POS) {
         return `-`;
      } else if (POS_ANTERIOR < POS) {
         return `‚ñº ${POS - POS_ANTERIOR}`;
      } else {
         return null;
      }
   }

   function reorganizarDadosRanking(ranking) {
      const keys = Object.keys(ranking);

      keys.sort();

      return keys.map((key) => ({
         'ranking': key,
         ...ranking[key]
      }));
   }
</script>

</html>