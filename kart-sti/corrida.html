<!DOCTYPE html>
<html>

<head>
   <!-- basic -->
   <meta charset="utf-8">
   <meta http-equiv="X-UA-Compatible" content="IE=edge">
   <meta name="viewport" content="width=device-width, initial-scale=1">
   <!-- mobile metas -->
   <meta name="viewport" content="width=device-width, initial-scale=1">
   <meta name="viewport" content="initial-scale=1, maximum-scale=1">
   <!-- site metas -->
   <title>üèéÔ∏è | STI Kart</title>
   <meta name="keywords" content="">
   <meta name="description" content="">
   <meta name="author" content="">
   <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
   <link rel="stylesheet" type="text/css" href="css/style.css">
   <link rel="stylesheet" href="css/responsive.css">
   <!-- fevicon -->
   <link rel="icon" href="images/fevicon.png" type="image/gif" />
   <!-- CSS -->
   <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
   <link rel="stylesheet" href="css/jquery.mCustomScrollbar.min.css">
   <link href="https://cdn.datatables.net/1.13.1/css/jquery.dataTables.min.css" rel="stylesheet">
   <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.dataTables.min.css">
   <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">


   <!-- BIBLIOTECAS -->
   <script src="./js/funcoes.js"></script>
   <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
   <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
   <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
   <script src="https://code.jquery.com/jquery-3.6.1.min.js"
      integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
   <script src="https://cdn.datatables.net/1.13.1/js/jquery.dataTables.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment-with-locales.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/js/all.min.js"
      integrity="sha512-u3fPA7V8qQmhBPNT5quvaXVa1mnnLSXUep5PS1qo5NRzHwG19aHmNJnj1Q8hpA/nBWZtZD4r4AX6YOt5ynLN2g=="
      crossorigin="anonymous" referrerpolicy="no-referrer"></script>

   <script src="js/popper.min.js"></script>
   <script src="js/bootstrap.bundle.min.js"></script>
   <script src="js/plugin.js"></script>
   <script src="https://d3js.org/d3.v7.min.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
   <script src="https://cdn.datatables.net/responsive/2.2.9/js/dataTables.responsive.min.js"></script>

   <script src="js/jquery.mCustomScrollbar.concat.min.js"></script>
   <script src="js/custom.js"></script>
</head>

<body>
   <div class="header_section header_bg">
      <div class="container">
         <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <a class="navbar-brand" href="index.html">
               <div class="h5 text-white">üèÅ<span class="font-italic"><span class="font-weight-light">KART//</span><span
                        class="font-weight-bold">STI</span></span></div>
            </a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
               aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
               <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
               <ul class="navbar-nav ml-auto">
                  <li class="nav-item">
                     <a class="nav-link active" href="corridas.html">Corridas</a>
                  </li>
                  <li class="nav-item">
                     <a class="nav-link" href="pilotos.html">Pilotos</a>
                  </li>
                  <li class="nav-item">
                     <a class="nav-link" href="ranking.html">Ranking</a>
                  </li>
                  <li class="nav-item">
                     <a class="nav-link" href="recordes.html">Recordes</a>
                  </li>
                  <li class="nav-item">
                     <a class="nav-link" href="regulamento.html">Regulamento</a>
                  </li>

               </ul>
            </div>
         </nav>
      </div>
   </div>

   <div class="contact_section layout_padding">
      <div class="container">
         <div class="h1 contact_taital" id="t√≠tuloCorrida"></div>
         <div>
            <p class="text-center" id="URLCorrida"></p>
         </div>

         <div class="row">
            <ul class="nav nav-tabs" id="myTab" role="tablist">
               <li class="nav-item">
                  <a class="nav-link active" id="tabelaClassifica√ß√£oCorrida-tab" data-toggle="tab"
                     href="#tabelaClassifica√ß√£oCorrida" role="tab" aria-controls="tabelaClassifica√ß√£oCorrida"
                     aria-selected="true">Classifica√ß√£o da Corrida</a>
               </li>
               <li class="nav-item" role="presentation">
                  <a class="nav-link" id="gr√°ficoEvolu√ß√£oCorrida-tab" data-toggle="tab" href="#gr√°ficoEvolu√ß√£oCorrida"
                     role="tab" aria-controls="gr√°ficoEvolu√ß√£oCorrida" aria-selected="false">Gr√°fico de evolu√ß√£o</a>
               </li>
               <li class="nav-item" role="presentation">
                  <a class="nav-link" id="tabelaTomadaDeTempo-tab" data-toggle="tab" href="#tabelaTomadaDeTempo"
                     role="tab" aria-controls="tabelaTomadaDeTempo" aria-selected="false">Grid de Largada</a>
               </li>
               <li class="nav-item" role="presentation">
                  <a class="nav-link" id="tabelaMelhoresVoltas-tab" data-toggle="tab" href="#tabelaMelhoresVoltas"
                     role="tab" aria-controls="tabelaMelhoresVoltas" aria-selected="false">Melhores Voltas</a>
               </li>
            </ul>
         </div>
         <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade show active" id="tabelaClassifica√ß√£oCorrida" role="tabelaClassifica√ß√£oCorrida"
               aria-labelledby="tabelaClassifica√ß√£oCorrida-tab" width="100%">
               <div class="table-responsive">
                  <table id="tabelaDeClassifica√ß√£oCorrida" class="table-hover-coffee table-coffee" style="width:100%">
                  </table>
               </div>
            </div>
            <div class="tab-pane fade" id="gr√°ficoEvolu√ß√£oCorrida" role="gr√°ficoEvolu√ß√£oCorrida"
               aria-labelledby="gr√°ficoEvolu√ß√£oCorrida-tab">
               <div class="row">
                  <div class="col-12">
                     <canvas id="gr√°ficoDeClassifica√ß√£oCorridaCanvas" width="100%" height="800"></canvas>
                  </div>
               </div>
            </div>
            <div class="tab-pane fade" id="tabelaTomadaDeTempo" role="tabelaTomadaDeTempo"
               aria-labelledby="tabelaTomadaDeTempotab">
               <div class="table-responsive">
                  <table id="tabelaDeTomadaDeTempo" class="table-hover-coffee table-coffee" style="width:100%">
                  </table>
               </div>
            </div>
            <div class="tab-pane fade" id="tabelaMelhoresVoltas" role="tabelaMelhoresVoltas"
               aria-labelledby="tabelaMelhoresVoltas-tab">
               <table id="tabelaDeMelhoresVoltas" class="table-hover-coffee table-coffee" style="width:100%">
               </table>
            </div>
         </div>
      </div>
   </div>

   <div class="copyright_section">
      <div class="container">
         <div class="row">
            <div class="col-sm-12">
               <p class="copyright_text">2024 | Rafael Nobre Leite.<br>Design by <a href="https://html.design">Free Html
                     Templates</a>
                  Distribution by <a href="https://themewagon.com">ThemeWagon</a></p>
            </div>
         </div>
      </div>
   </div>
</body>

<script>
   $(document).ready(async function () {

      const url = window.location.href;
      const BATERIA = (new URL(url)).searchParams.get('bateria');
      window.CORRIDA = {};

      await carregarArquivoJSON(BATERIA);

      function carregarArquivoJSON(files) {
         const url = `./data/baterias/${BATERIA}.json`;
         return fetch(url)
            .then((response) => {
               if (!response.ok) {
                  throw new Error(`Erro ao carregar ${file}: ${response.statusText}`);
               }
               return response.json();
            })
            .then((jsonData) => {
               CORRIDA = jsonData;
            })
            .catch((error) => console.error('Erro ao carregar arquivo JSON:', error));

         return Promise.all(fetchPromises);
      }

      $(`#t√≠tuloCorrida`).html(formatarData(BATERIA));
      $(`#URLCorrida`).html(`<a href="${CORRIDA.url}" target="_blank">Ver resultado no LapTime</a>`);
      gerarTabelaDeClassifica√ß√£oCorrida(CORRIDA);
      gerarTabelaDeTomadaDeTempo(CORRIDA);
      gerarTabelaDeMelhoresVoltas(CORRIDA);
      atualizarGr√°ficoDeClassifica√ß√£oCorrida(CORRIDA);
   });

   function gerarTabelaDeClassifica√ß√£oCorrida(dados) {

      window.callDetalhesTabelaDeClassifica√ß√£oCorrida = false;

      if (window.hasOwnProperty('tabelaDeClassifica√ß√£oCorrida')) {
         $(`#tabelaDeClassifica√ß√£oCorrida`).DataTable().destroy();
         callDetalhesTabelaDeClassifica√ß√£oCorrida = false;
      }

      window.tabelaDeClassifica√ß√£oCorrida = $(`#tabelaDeClassifica√ß√£oCorrida`).DataTable({
         data: dados.corrida,
         dom: 'rt',
         ordering: false,
         pageLength: -1,
         columns: [
            {
               data: 'POS',
               class: 'text-center align-middle pointer h5',
               render: function (data, type, full, meta) {
                  return `${data}¬∫`;
               }
            },
            {
               data: 'NOME',
               class: 'align-middle pointer',
               render: function (data, type, full, meta) {
                  return `<strong>#${full['#']}</strong> ${full['NOME']} ${full['MVC'] ? `<span class="badge badge-pill badge-warning">MELHOR VOLTA</span>` : ''}`;
               }
            },
            {
               data: 'POS',
               class: 'text-center align-middle pointer',
               render: function (data, type, full, meta) {
                  if (full.POS == 1) return full['TT'].replace('.', ',')
                  return full['DL'].includes('VOLTA') ? full['DL'] : `+${full['DL'].replace('.', ',')}`;
               }
            }
         ]
      });

      if (!callDetalhesTabelaDeClassifica√ß√£oCorrida) {
         callDetalhesTabelaDeClassifica√ß√£oCorrida = true;
         configurarDetalhesTabelaDeClassifica√ß√£oCorrida(dados);
      }
   }

   function gerarTabelaDeTomadaDeTempo(dados) {

      window.callDetalhesTabelaDeTomadaDeTempo = false;

      if (window.hasOwnProperty('tabelaDeTomadaDeTempo')) {
         $(`#tabelaDeTomadaDeTempo`).DataTable().destroy();
         callDetalhesTabelaDeTomadaDeTempo = false;
      }

      window.tabelaDeTomadaDeTempo = $(`#tabelaDeTomadaDeTempo`).DataTable({
         data: dados.tomada_de_tempo,
         dom: 'rt',
         ordering: false,
         pageLength: -1,
         columns: [
            {
               data: 'POS',
               class: 'text-center align-middle pointer h5',
               render: function (data, type, full, meta) {
                  return `${data}¬∫`;
               }
            },
            {
               data: 'NOME',
               class: 'align-middle pointer',
               render: function (data, type, full, meta) {
                  return `<strong>#${full['#']}</strong> ${full['NOME']} ${full['MVC'] ? `<span class="badge badge-pill badge-warning">MELHOR VOLTA</span>` : ''}`;
               }
            },
            {
               data: 'TMV',
               class: 'text-center align-middle pointer'
            }
         ]
      });

      // if (!callDetalhesTabelaDeTomadaDeTempo) {
      //    callDetalhesTabelaDeTomadaDeTempo = true;
      //    configurarDetalhesTabelaDeTomadaDeTempo(dados);
      // }
   }

   function gerarTabelaDeMelhoresVoltas(dados) {

      let voltas = [];

      dados.corrida.forEach(piloto => {

         let voltasP = piloto.MAPA_VOLTAS.filter(v => v).map((v, idx) => {
            return {
               piloto: piloto.NOME,
               kart: piloto['#'],
               volta: idx + 1,
               tempo: v
            }
         });
         voltas = voltas.concat(voltasP);
      });

      voltas.sort((a, b) => a.tempo > b.tempo ? 1 : -1);

      const top10 = voltas.slice(0, 10);
      const tempo10 = top10[top10.length - 1].tempo;
      const extras = voltas.slice(10).filter(item => item.tempo === tempo10);
      const resultado = top10.concat(extras);

      if (window.hasOwnProperty('tabelaDeMelhoresVoltas')) {
         $(`#tabelaDeMelhoresVoltas`).DataTable().destroy();
         callDetalhesTabelaDeMelhoresVoltas = false;
      }

      window.tabelaDeMelhoresVoltas = $(`#tabelaDeMelhoresVoltas`).DataTable({
         data: resultado,
         dom: 'rt',
         ordering: false,
         pageLength: -1,
         columns: [
            {
               data: 'POS',
               class: 'text-center align-middle pointer h5',
               render: function (data, type, full, meta) {
                  return `${meta.row == 0 ? `1¬∫` : resultado[meta.row].tempo === resultado[meta.row - 1].tempo ? '-' : `${meta.row + 1}¬∫`}`;
               }
            },
            {
               data: 'piloto',
               class: 'align-middle pointer',
               render: function (data, type, full, meta) {
                  return `<strong>#${full.kart}</strong> ${full.piloto}`;
               }
            },
            {
               data: 'volta',
               class: 'align-middle pointer',
               render: function (data, type, full, meta) {
                  return `Volta ${data}`;
               }
            },
            {
               data: 'tempo',
               class: 'text-center align-middle pointer'
            }
         ]
      });

   }

   async function configurarDetalhesTabelaDeClassifica√ß√£oCorrida(CORRIDA) {
      $(`#tabelaDeClassifica√ß√£oCorrida tbody`).on(`click`, `td.pointer`, async function () {
         let tr = $(this).closest(`tr`);
         let row = tabelaDeClassifica√ß√£oCorrida.row(tr);

         if (row.child.isShown()) {
            row.child.hide();
            tr.removeClass(`active`);
         } else {
            $('#tabelaDeClassifica√ß√£oCorrida tr').removeClass('active');

            $('#tabelaDeClassifica√ß√£oCorrida').DataTable().rows().every(function () {
               var row = this;

               if (row.child.isShown()) {
                  row.child.hide();
                  $(row.node()).removeClass('shown');
               }
            });

            gerarDetalhePiloto(row.data(), CORRIDA)
               .then(el => row.child(el, 'child p-3').show())
               .then(el => atualizarGr√°ficoMapaDeVoltas(row.data(), CORRIDA));
            tr.addClass(`active`);
         }
      });
   }

   async function gerarDetalhePiloto(d, CORRIDA) {
      console.log(d);
      let tt = CORRIDA.tomada_de_tempo.find(el => el.NOME == d.NOME);
      let detalhesPiloto = [`<div class="h6">Estat√≠sticas</div>`];
      let pontuacao = [`<div class="h6">Pontua√ß√£o</div>`];

      d['VLTS'] && detalhesPiloto.push(`<div><b>N√∫mero de voltas: </b>${d['VLTS']}</div>`);
      d['TT'] && detalhesPiloto.push(`<div><b>Tempo total: </b>${d['TT'].replace('.', ',')}</div>`);
      d['VM'] && detalhesPiloto.push(`<div><b>Velocidade M√©dia: </b>${numeroBr(d['VM'], 2)} Km/h</div>`);
      d['TMV'] && detalhesPiloto.push(`<div><b>Tempo da Melhor Volta: </b>${d['TMV'].replace('.', ',')}</div>`);
      d['DA'] && d['DA'] != '---' && detalhesPiloto.push(`<div> <b>Diferen√ßa para o anterior: </b>${d['DA'].replace('.', ',')}</div>`);

      let pcc = caulcarPCC(d['POS'], CORRIDA.corrida.length);
      let pmv = d['MVC'] ? caulcarPMV(CORRIDA.corrida.length) : 0;
      let pctt = caulcarPCTT(tt['POS'], CORRIDA.tomada_de_tempo.length);
      let pvc = caulcarPVC(d.MAPA_VOLTAS.filter(el => el).length + tt.MAPA_VOLTAS.filter(el => el).length);

      pontuacao.push(`<div><b>P<sub>CC</sub>: </b>${numeroBr(pcc, 2, 2)}</div>`);
      pontuacao.push(`<div><b>P<sub>MV</sub>: </b>${numeroBr(pmv, 2, 2)}</div>`);
      pontuacao.push(`<div><b>P<sub>CTT</sub>: </b>${numeroBr(pctt, 2, 2)}</div>`);
      pontuacao.push(`<div><b>P<sub>VC</sub>: </b>${numeroBr(pvc, 2, 2)}</div>`);
      pontuacao.push(`<div><b>Pontua√ß√£o Total: </b>${numeroBr(pcc + pmv + pctt + pvc, 2, 2)}</div>`);

      return `<div class="row">
            <div class="col-6">${detalhesPiloto.join('')}</div>
            <div class="col-6">${pontuacao.join('')}</div>
         </div>
         <div class="row mt-3">
            <div class="col-12">
               <div style="position: relative; height: 400px;">
               <canvas id="graficoMapaDeVoltasCanvas_${d['NOME']}" style="height: 100%; width: 100%"></canvas>
               </div>
            </div>
         </div>`;
   }

   function atualizarGr√°ficoDeClassifica√ß√£oCorrida() {

      if (typeof gr√°ficoDeClassifica√ß√£oCorrida != 'undefined' && gr√°ficoDeClassifica√ß√£oCorrida) {
         gr√°ficoDeClassifica√ß√£oCorrida.destroy();
      }

      let dados = CORRIDA;

      const N_VOLTAS = dados.corrida[0]['MAPA_VOLTAS_ACC_ms'].length;

      let largada = dados.tomada_de_tempo.map(el => {
         return {
            NOME: el.NOME,
            POS: Number(el.POS)
         }
      });

      let chegada = dados.corrida.map(el => {
         return {
            NOME: el.NOME,
            POS: Number(el.POS)
         }
      });

      let voltas = [];

      for (let i = 0; i < N_VOLTAS; i++) {
         let volta = dados.corrida.map(el => {
            return {
               NOME: el.NOME,
               TEMPO: el['MAPA_VOLTAS_ACC_ms'][i]
            }
         });

         voltas.push(volta.filter(el => el.TEMPO).sort((a, b) => a.TEMPO - b.TEMPO));
      }

      let pilotosPosi√ß√µes = [];

      dados.corrida.forEach((el) => {
         let p = {
            NOME: el.NOME,
            POS: []
         };

         let largada_obj = largada.find(el2 => el2.NOME == p.NOME);

         if (largada_obj) {
            p.POS.push(largada.find(el2 => el2.NOME == p.NOME).POS);
         } else {
            p.POS.push(null);
         }

         for (let i = 0; i < voltas.length; i++) {
            let volta = voltas[i].find(el2 => el2.NOME == p.NOME);
            if (volta && volta.TEMPO) {
               p.POS.push(voltas[i].findIndex(el2 => el2.NOME == p.NOME) + 1);
            } else {
               p.POS.push(chegada.find(el2 => el2.NOME == p.NOME).POS);
            }
         }
         p.POS.push(chegada.find(el2 => el2.NOME == p.NOME).POS);

         pilotosPosi√ß√µes.push(p);
      });


      const R√ìTULOS = ['LARGADA', ...Array.from({ length: N_VOLTAS }, (_, i) => i + 1), 'CHEGADA'];

      const datasets = pilotosPosi√ß√µes.map((piloto, idx) => ({
         label: piloto.NOME,
         data: piloto.POS,
         borderColor: paletaDeCores[idx],
         pointRadius: 0,
         fill: false,
         lineTension: 0,
      }));

      const ctx = document.getElementById("gr√°ficoDeClassifica√ß√£oCorridaCanvas").getContext("2d");
      window.gr√°ficoDeClassifica√ß√£oCorrida = new Chart(ctx, {
         type: "line",
         data: {
            labels: R√ìTULOS,
            datasets: datasets,
         },
         options: {
            scales: {
               y: {
                  reverse: true,
                  beginAtZero: false,
                  title: {
                     display: true,
                     text: "Posi√ß√£o",
                  },
               },
               x: {
                  title: {
                     display: true,
                     text: "Voltas",
                  },
               },
            },
            plugins: {
               legend: {
                  position: "bottom",
                  labels: {
                     boxHeight: 0
                  }
               },
               tooltip: {
                  backgroundColor: "rgba(255,255,255,0.5)",
                  borderColor: '#dddfeb',
                  titleColor: `#000000`,
                  bodyColor: `#000000`,
                  position: 'nearest',
                  borderWidth: 1,
                  displayColors: false,
                  caretPadding: 5,
               },
            },
            interaction: {
               mode: 'nearest',
               intersect: false
            },
            responsive: true,
            aspectRatio: 1,
            maintainAspectRatio: false,
            onHover: function (event, activeElements) {
               gr√°ficoDeClassifica√ß√£oCorrida.data.datasets.forEach((dataset) => {
                  dataset.borderWidth = 2;
               });

               if (activeElements.length > 0) {
                  const activeDatasetIndex = activeElements[0].datasetIndex;
                  gr√°ficoDeClassifica√ß√£oCorrida.data.datasets[activeDatasetIndex].borderWidth = 6;
               }

               gr√°ficoDeClassifica√ß√£oCorrida.update();
            }
         },
      });

   }

   $('#myTab a').on('click', function (e) {
      e.preventDefault();
      $(this).tab('show');
      if ($(this).attr('id') == 'gr√°ficoEvolu√ß√£oCorrida-tab' && (typeof gr√°ficoDeClassifica√ß√£oCorrida == 'undefined' || gr√°ficoDeClassifica√ß√£oCorrida.height == 1 || gr√°ficoDeClassifica√ß√£oCorrida.height == 0)) {
         setTimeout(() => { atualizarGr√°ficoDeClassifica√ß√£oCorrida(); }, 250);
      }
   });

   function atualizarGr√°ficoMapaDeVoltas(d, CORRIDA) {


      if (typeof window[`graficoMapaDeVoltas_${d["NOME"]}`] !== 'undefined' && window[`graficoMapaDeVoltas_${d["NOME"]}`]) {
         window[`graficoMapaDeVoltas_${d["NOME"]}`].destroy();
      }

      const R√ìTULOS = Array.from({ length: d["MAPA_VOLTAS_ms"].length }, (_, i) => (i + 1).toString());;

      const ctx = document.getElementById(`graficoMapaDeVoltasCanvas_${d["NOME"]}`).getContext("2d");
      window[`graficoMapaDeVoltas_${d["NOME"]}`] = new Chart(ctx, {
         type: "bar",
         data: {
            labels: R√ìTULOS,
            datasets: [{
               label: 'Tempo das Voltas',
               data: d["MAPA_VOLTAS_ms"],
               backgroundColor: 'rgba(75, 192, 192, 0.2)',
               borderColor: 'rgba(75, 192, 192, 1)',
               borderWidth: 1
            }],
         },
         options: {
            scales: {
               y: {
                  beginAtZero: true,
                  title: {
                     display: true,
                     text: "Tempo",
                  },
                  ticks: {
                     callback: function (value) {
                        return converterParaMMSS(value);
                     }
                  }
               },
               x: {
                  title: {
                     display: true,
                     text: "Volta",
                  },
               },
            },
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
               tooltip: {
                  callbacks: {
                     label: function (context) {
                        const value = context.raw;
                        return `Tempo: ${converterParaMMSS(value)}`;
                     }
                  }
               }
            },
            layout: {
               padding: {
                  left: 10,
                  right: 10,
                  top: 0,
                  bottom: 0
               }
            }
         },
      });

   }

</script>

</html>